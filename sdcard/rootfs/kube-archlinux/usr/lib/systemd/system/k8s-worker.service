[Unit]
Description=The Master Components for Kubernetes
After=docker.service

[Service]
EnvironmentFile=/etc/kubernetes/k8s.conf
ExecStartPre=-/usr/bin/docker kill k8s-worker worker-k8s-proxy
ExecStartPre=-/usr/bin/docker rm k8s-worker worker-k8s-proxy
ExecStart=/bin/bash -c "source /etc/kubernetes/k8s.conf; exec docker run --name=k8s-worker --net=host -v /var/run/docker.sock:/var/run/docker.sock k8s/hyperkube /hyperkube kubelet --pod_infra_container_image="k8s/pause" --api-servers=http://${K8S_MASTER_IP}:8080 --v=2 --address=127.0.0.1 --enable-server --hostname-override=$(/usr/bin/hostname -i | /usr/bin/awk '{print $1}')"
ExecStartPost=/usr/bin/docker run -d --name=worker-k8s-proxy --net=host --privileged k8s/hyperkube /hyperkube proxy --master=http://${K8S_MASTER_IP}:8080 --v=2
ExecStop=/usr/bin/docker stop k8s-worker worker-k8s-proxy

[Install]
WantedBy=multi-user.target